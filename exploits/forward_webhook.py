"""
Forward SMS messages received by phone to a second phone number using SMSGATE
"""

import argparse
from flask import Flask, request, jsonify
import requests

PHONE_SMSGATE_LISTEN_ADDR = ""

app = Flask(__name__)

def register():
    payload = {
        "id": "forward1",
        "url": PHONE_SMSGATE_LISTEN_ADDR,
        "event": "sms:received"
    }

    response = requests.post(
        PHONE_SMSGATE_LISTEN_ADDR + "/webhooks",
        auth=("sms", "passywissy"),
        json=payload
    )

def send_sms(phone, msg):
    payload = {
        'message': msg,
        'phoneNumbers': [phone]
    }

    response = requests.post(
        PHONE_SMSGATE_LISTEN_ADDR + "/message",
        auth=("sms", "pass"),
        json=payload
    )
    # Check if the request was successful
    if response.status_code != 202:
        raise Exception()
    print(f"TOTP delivered to {phone}")

@app.route('/', methods=['POST'])
def webhook():
    json_data = request.json
    print(f"new notification {json_data}")
    if 'event' in json_data and "sms:received" in json_data['event'] \
        and 'payload' in json_data and 'message' in json_data['payload'] \
        and 'TOTPY' in json_data['payload']['message']:
        send_sms(phone, json_data['payload']['message'])
    
    return jsonify({'status': 'success'}), 200

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Forward SMS OTP to phone number')
    parser.add_argument('phone', type=str, help='Phone number to forward OTP to.')

    # Parse the command-line arguments
    args = parser.parse_args()
    phone = args.phone
    register()
    app.run(port=7000, host='0.0.0.0')
